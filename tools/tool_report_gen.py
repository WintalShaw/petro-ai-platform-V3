# tools/tool_report_gen.py
import streamlit as st
import time
import random


def run(context):
    # 模拟生成长报告的耗时
    time.sleep(1.0)
    return "报告构建完成"


def view(context):
    st.markdown("### 📝 AI 决策报告生成引擎")

    # 1. 获取上下文数据
    month = context.get('month', 7)
    task = context.get('task_name', '通用分析')

    # 获取前面步骤生成的结论，如果没有则使用默认话术
    trend_concl = context.get('trend_summary', '本月产量整体运行平稳，波动在可控范围内，未见明显异常趋势。')
    risk_concl = context.get('risk_summary', '全区生产形势稳定，未监测到一级井控风险，设备运行状况良好。')
    water_concl = context.get('water_summary', '注采结构基本合理，地层压力保持水平，建议维持当前配注方案微调。')

    # 2. 定义通用头部信息
    report_header = f"""# {month}月度{task}智能化决策分析报告
**密级**: 内部绝密 | **生成时间**: {time.strftime('%Y-%m-%d %H:%M')}
**数据范围**: 第五采油厂作业区 | **分析引擎**: Petro-Brain AI V3.2
---
"""

    # 3. 根据任务类型构建长文本内容
    report_body = ""

    # --- 场景 A: 产量预测报告 ---
    if task == "产量预测":
        report_body = f"""
## 一、 生产运行综述
本月作业区以“控递减、提时率”为核心目标，通过 AI 指挥系统对全区 1,200 余口油水井进行了全天候数据监控。截止目前，实际日产油水平与月度计划线吻合度达到 98.5%。{trend_concl} 数据显示，综合含水率较上月环比持平，自然递减率控制在 11.2% 以内。

## 二、 趋势预测模型分析 (LSTM-V2)
基于深度长短期记忆网络（LSTM）对历史 36 个月的产量曲线进行拟合推演：
1.  **上旬趋势**: 预计产量维持高位运行，日产波动幅度不超过 ±5 吨。
2.  **中旬拐点**: 受周期性洗井及部分井检泵周期的影响，预计在 12-15 日期间出现短暂的产量下探，降幅约为 2-3%。
3.  **下旬回升**: 随着措施井效果显现及新井投产，下旬产量将呈现“U型”回升态势，月末有望突破日产计划峰值。

## 三、 存在问题与归因
虽然整体趋势向好，但通过多维因子关联分析发现：
*   **液量波动**: 3 号断块部分高液量井动液面出现下降趋势，供液不足风险增加。
*   **含水上升**: 局部低效循环场依然存在，部分老井含水上升率加快，需警惕水淹风险。

## 四、 下一步生产建议
1.  **精细管理**: 针对模型预测出的中旬低谷期，建议提前 3 天安排重点井的加药与热洗维护，减少非计划停机时间。
2.  **参数优化**: 建议对动液面下降的 12 口井下调冲次 0.5-1 次/min，保持合理的沉没度，提升泵效。
3.  **措施跟进**: 加快新井投产进度，确保月末产量硬过手。
"""

    # --- 场景 B: 风险预测报告 ---
    elif task == "风险预测":
        report_body = f"""
## 一、 安全生产态势总览
本月通过 XGBoost 风险预警分类器对全区井站设施进行了全覆盖扫描。系统重点对载荷曲线异常、压力激增、管线穿孔及电机电流波动等 15 类风险因子进行了实时监测。扫描结果显示：{risk_concl} 整体安全生产形势平稳受控。

## 二、 重点风险研判
根据 AI 模型的特征重要性排序，本月需重点关注以下几类潜在隐患：
1.  **杆管偏磨风险**: 随着含水率上升，部分定向井段腐蚀加剧，模型预测出 8 口井存在高概率杆断脱风险（置信度 > 85%）。
2.  **异常高压预警**: 注水系统中有 3 个配水间管网压力接近临界值，存在刺漏隐患。
3.  **工况异常**: 数字化示功图诊断发现，有 15 口井呈现“气体影响”或“供液不足”特征，不仅影响产量，更加速设备老化。

## 三、 数字化诊断结论
经系统关联分析，本月风险主要集中在西区老井区块。数据清洗引擎剔除了 35 个因传感器故障导致的误报警，最终锁定了 12 个确信度极高的红色预警目标。这些井的电流方差在过去 72 小时内显著增大，预示着井下结蜡或卡泵风险急剧升高。

## 四、 应急响应与维保建议
1.  **立即核查**: 请生产运行科立即将红色预警清单下发至基层班站，要求 24 小时内完成现场复核（如憋压测试、电流卡片检查）。
2.  **预防性作业**: 针对偏磨风险井，建议在下一轮作业中加装扶正器或使用内衬油管。
3.  **智能调控**: 建议启用系统的“智能过载保护”功能，对异常电流井实施自动停机保护，防止烧毁电机。
"""

    # --- 场景 C: 注水调配报告 ---
    elif task == "注水调配":
        report_body = f"""
## 一、 水驱开发利用现状
为确保持续稳产，本月利用强化学习（DQN）模型对区块注采关系进行了深度重构。当前开发单元存在的主要矛盾是：层间吸水差异大，主力层水淹严重，而低渗透层动用程度不足，导致无效注水循环比例上升。{water_concl}

## 二、 智能配注方案解析
本次生成的优化方案旨在“控水稳油、均衡压力”。模型通过 50,000 次模拟迭代，输出了以下核心策略：
1.  **控水降压**: 对 5 口高含水采油井对应的高注水井实施“强注强采”向“温和注水”转变，单井日注量平均下调 10-15 m³。
2.  **增注提压**: 针对欠注严重的 8 号断块，建议通过提高泵压或酸化增注措施，提升地层能量，预计日增注 80 m³。
3.  **流场重构**: 调整 3 对注采井组的流线方向，扩大水驱波及体积，预计可提高最终采收率 0.5 个百分点。

## 三、 预期效果评估
若严格执行本 AI 配注方案，预计下月将实现以下指标改善：
*   **自然递减率**: 延缓 0.8% - 1.2%。
*   **注采合格率**: 提升至 85% 以上。
*   **地层压力保持水平**: 恢复至原始地层压力的 92% 左右。

## 四、 实施保障措施
1.  **分步实施**: 建议优先调整上述方案中“调整量”最大的前 20% 井次，观察 3-5 天压力响应后再全面推广。
2.  **水质监测**: 加强注入水质化验，防止因水质不达标造成地层堵塞，影响增注效果。
3.  **动态跟踪**: 建议每 10 天重新运行一次本模型，根据压力变化动态微调配注量。
"""

    full_text = report_header + report_body

    # 4. 界面渲染（打字机效果）
    st.markdown(f"#### 📄 正在生成《{month}月{task}分析报告》...")

    # 容器占位
    report_container = st.container(border=True)

    # 模拟打字机速度（稍微快一点，因为字多了）
    # 使用 placeholder 来避免每次都重新渲染整个 markdown
    text_placeholder = report_container.empty()

    display_text = ""
    # 为了演示流畅，不再一个字一个字打，而是一小段一小段打
    chunk_size = 5

    for i in range(0, len(full_text), chunk_size):
        chunk = full_text[i:i + chunk_size]
        display_text += chunk
        # 加上光标
        text_placeholder.markdown(display_text + " ▍")
        time.sleep(0.01)  # 极速打字

    text_placeholder.markdown(display_text)  # 最后移除光标

    # 5. 交互区
    col1, col2 = st.columns([1, 1])
    with col1:
        st.download_button(
            label="📥 导出完整报告 (.docx)",
            data=full_text,
            file_name=f"生产指挥部_{month}月_{task}_分析报告.md",
            mime="text/markdown",
            use_container_width=True
        )
    with col2:
        st.button("📧 发送邮件给主管", disabled=True, help="系统演示模式暂不支持邮件发送", use_container_width=True)

    # 将生成的摘要存回去，防止后续步骤需要（虽然这里已经是最后了）
    context['generated_report_content'] = full_text